tosca_definitions_version: alien_dsl_2_0_0

metadata:
  template_name: ddi-types
  template_version: 0.1.0
  template_author: yorc

imports:
  - tosca-normative-types:1.0.0-ALIEN20
  - yorc-types:1.1.0

artifact_types:
  org.ddi.artifacts.Deployment:
    derived_from: tosca.artifacts.Deployment
  yorc.artifacts.Deployment.SlurmJob:
    description: Docker Container Image
    derived_from: tosca.artifacts.Deployment.Image
node_types:
  org.ddi.nodes.pub.Cloud:
    derived_from: tosca.nodes.Root
    abstract: true
    description: >
      Parent type of DDI cloud-related node types (abstract)
    capabilities:
      cloud_staging_area_access:
        type: org.ddi.capabilities.CloudStagingAreaAccess
  org.ddi.nodes.DDICloudStagingArea:
    derived_from: org.ddi.nodes.pub.Cloud
    description: >
      Gets the DDI Cloud Staging Area to use according to the location of the associated Compute Instance
    # Atributes added here in addition to capability attributes, so that they
    # can be referenced with the REQ_TARGET keyword
    attributes:
      remote_file_system:
        type: string
        description: remote file system to mount to access the staging area
      mount_type:
        type: string
        description: Type of file system
      mount_options:
        type: string
        description: mount options to use
      user_id:
        type: string
        description: ID of the user with read/write access to this file system
      group_id:
        type: string
        description: ID of the unix group with read/write access to this file system
    requirements:
      - os:
          capability: tosca.capabilities.OperatingSystem
          node: tosca.nodes.Compute 
          relationship: org.ddi.relationships.SameSite
          occurrences: [1, 1]
    interfaces:
      Standard:
        create:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
        delete:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
  org.ddi.nodes.pub.DDIToCloudJob:
    derived_from: org.ddi.nodes.pub.Cloud
    abstract: true
    description: >
      Transfer datasets from DDI to Cloud staging area (abstract)
    properties:
      token:
        description: Access token
        type: string
        required: true
      ddi_dataset_path:
        description: Path of the DDI dataset to transfer to the Cloud staging area
        type: string
        required: true
      cloud_staging_area_dataset_path:
        description: Path where to transfer the dataset in Cloud staging area
        type: string
        required: true
    attributes:
      request_id:
        type: string
        description: >
          ID of the DDI request created
    capabilities:
      ddi_to_cloud:
        type: org.ddi.capabilities.DDIToCloud
    interfaces:
      Standard:
        create:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
        delete:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
      tosca.interfaces.node.lifecycle.Runnable:
        inputs:
          TOKEN: { get_property: [SELF, token] }
        submit:
          inputs:
            DDI_DATASET_PATH: { get_property: [SELF, ddi_dataset_path] }
            CLOUD_STAGING_AREA_DATASET_PATH: { get_property: [SELF, cloud_staging_area_dataset_path] }
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
        run:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
        cancel:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
  org.ddi.nodes.DDIToCloudJob:
    derived_from: org.ddi.nodes.pub.DDIToCloudJob
    description: >
      Transfer datasets from DDI to Cloud staging area
  org.ddi.nodes.pub.CloudToDDIJob:
    derived_from: org.ddi.nodes.pub.Cloud
    abstract: true
    description: >
      Transfer datasets from Cloud staging area to DDI (abstract)
    properties:
      token:
        description: Access token
        type: string
        required: true
      ddi_path:
        description: Path where to transfer the dataset in DDI
        type: string
        required: true
    attributes:
      request_id:
        type: string
        description: >
          ID of the DDI request created
      ddi_dataset_path:
        type: string
        description: Path to the dataset transferred in DDI
    capabilities:
      cloud_to_ddi:
        type: org.ddi.capabilities.CloudToDDI
    requirements:
      - dataset_provider:
          capability: org.ddi.capabilities.CloudAreaDatasetProvider
          relationship: org.ddi.relationships.DatasetProvider
          occurrences: [1, 1]
    interfaces:
      Standard:
        create:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
        delete:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
      tosca.interfaces.node.lifecycle.Runnable:
        inputs:
          TOKEN: { get_property: [SELF, token] }
        submit:
          inputs:
            DDI_PATH: { get_property: [SELF, ddi_path] }
            CLOUD_STAGING_AREA_DATASET_PATH: { get_attribute: [REQ_TARGET, dataset_provider, dataset_path] }
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
        run:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
        cancel:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
  org.ddi.nodes.CloudToDDIJob:
    derived_from: org.ddi.nodes.pub.CloudToDDIJob
    description: >
      Transfer datasets from Cloud staging area to DDI
  org.ddi.nodes.pub.DeleteCloudDataJob:
    derived_from: tosca.nodes.Root
    abstract: true
    description: >
      Delete a dataset from Cloud staging area (abstract)
    properties:
      token:
        description: Access token
        type: string
        required: true
    attributes:
      request_id:
        type: string
        description: >
          ID of the DDI request created
    capabilities:
      cloud_delete:
        type: org.ddi.capabilities.DeleteCloudData
    requirements:
      - dataset_provider:
          capability: org.ddi.capabilities.CloudAreaDatasetProvider
          relationship: org.ddi.relationships.DatasetProvider
          occurrences: [1, 1]
    interfaces:
      Standard:
        create:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
        delete:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
      tosca.interfaces.node.lifecycle.Runnable:
        inputs:
          TOKEN: { get_property: [SELF, token] }
        submit:
          inputs:
            CLOUD_STAGING_AREA_DATASET_PATH: { get_attribute: [REQ_TARGET, dataset_provider, dataset_path] }
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
        run:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
        cancel:
          implementation:
            file: ddi-types-a4c.yaml
            type: yorc.artifacts.Deployment.SlurmJob
  org.ddi.nodes.DeleteCloudDataJob:
    derived_from: org.ddi.nodes.pub.DeleteCloudDataJob
    description: >
      Transfer datasets from DDI to Cloud instances
capability_types:
  org.ddi.capabilities.DDIToCloud:
    derived_from: tosca.capabilities.Root
    description: >
      A capability fulfilling requirements of a node requiring to be associated with a DDIToCloud Job.
  org.ddi.capabilities.CloudToDDI:
    derived_from: tosca.capabilities.Root
    description: >
      A capability fulfilling requirements of a node requiring to be associated with a CloudToDDI Job.
    attributes:
      ddi_dataset_path:
        type: string
        description: Path to the dataset transferred in DDI
  org.ddi.capabilities.CloudStagingAreaAccess:
    derived_from: tosca.capabilities.Root
    description: >
      A capability providing details on the access to Cloud Staging area
    attributes:
      remote_file_system:
        type: string
        description: remote file system to mount to access the staging area
      mount_type:
        type: string
        description: Type of file system
      mount_options:
        type: string
        description: mount options to use
      user_id:
        type: string
        description: ID of the user with read/write access to this file system
      group_id:
        type: string
        description: ID of the unix group with read/write access to this file system
  org.ddi.capabilities.DeleteCloudData:
    derived_from: tosca.capabilities.Root
    description: >
      A capability fulfilling requirements of a node requiring to be
      associated with a DeleteCloudData Job.
  org.ddi.capabilities.CloudAreaDatasetProvider:
    derived_from: tosca.capabilities.Root
    description: >
      A capability of a node providing a dataset in the Cloud Staging area
    attributes:
      dataset_path:
        type: string
        description: Path of the dataset in Cloud staging area
relationship_types:
  org.ddi.relationships.SameSite:
    derived_from: tosca.relationships.DependsOn
    description: >
      Source must must be on same site as target
    valid_target_types: [ tosca.capabilities.OperatingSystem ]
  org.ddi.relationships.DatasetProvider:
    derived_from: tosca.relationships.DependsOn
    description: >
      Relationship with a provider of dataset
    valid_target_types: [ org.ddi.capabilities.CloudAreaDatasetProvider ]
